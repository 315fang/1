<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’• æƒ…ä¾£ç½‘ç«™ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            padding: 30px 0;
            font-weight: 300;
            letter-spacing: 4px;
        }

        h1 span {
            color: #ff6b9d;
        }

        /* ç™»å½•é¢æ¿ */
        #login-panel {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: #1a1a1a;
            border-radius: 16px;
            border: 1px solid #333;
        }

        #login-panel h2 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: 300;
        }

        #login-panel input {
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #0a0a0a;
            color: #fff;
            font-size: 16px;
        }

        #login-panel button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #login-panel button:hover {
            transform: scale(1.02);
        }

        /* ä¸»é¢æ¿ */
        #main-panel {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid #333;
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active,
        .tab:hover {
            background: #ff6b9d;
            color: #fff;
            border-color: #ff6b9d;
        }

        .panel {
            display: none;
            animation: fadeIn 0.3s;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: #fff;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            color: #fff;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
        }

        .btn:hover {
            transform: scale(1.02);
            opacity: 0.9;
        }

        /* åˆ—è¡¨æ ·å¼ */
        .list-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item-info h4 {
            margin-bottom: 5px;
        }

        .list-item-info p {
            color: #888;
            font-size: 14px;
        }

        .list-item-actions {
            display: flex;
            gap: 10px;
        }

        .list-item-actions button {
            padding: 8px 16px;
            font-size: 12px;
        }

        .add-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed #333;
            background: transparent;
            color: #888;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .add-btn:hover {
            border-color: #ff6b9d;
            color: #ff6b9d;
        }

        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            background: #22c55e;
            color: #fff;
            border-radius: 8px;
            animation: slideIn 0.3s;
            z-index: 200;
        }

        .toast.error {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ’• <span>æƒ…ä¾£ç½‘ç«™</span> ç®¡ç†åå°</h1>

        <!-- ç™»å½•é¢æ¿ -->
        <div id="login-panel">
            <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
            <input type="password" id="password" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç " onkeypress="if(event.key==='Enter')login()">
            <button onclick="login()">ç™» å½•</button>
        </div>

        <!-- ä¸»é¢æ¿ -->
        <div id="main-panel">
            <button class="btn btn-secondary logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('profile')">ğŸ‘« æƒ…ä¾£ä¿¡æ¯</button>
                <button class="tab" onclick="switchTab('photos')">ğŸ“· ç…§ç‰‡ç®¡ç†</button>
                <button class="tab" onclick="switchTab('timeline')">ğŸ“… æ—¶é—´è½´</button>
            </div>

            <!-- æƒ…ä¾£ä¿¡æ¯ -->
            <div id="profile-panel" class="panel active">
                <div class="form-row">
                    <div class="form-group">
                        <label>ä»–çš„åå­—</label>
                        <input type="text" id="name1" placeholder="è¾“å…¥åå­—">
                    </div>
                    <div class="form-group">
                        <label>å¥¹çš„åå­—</label>
                        <input type="text" id="name2" placeholder="è¾“å…¥åå­—">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ä»–çš„å¤´åƒURL</label>
                        <input type="text" id="avatar1" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>å¥¹çš„å¤´åƒURL</label>
                        <input type="text" id="avatar2" placeholder="https://...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åœ¨ä¸€èµ·æ—¥æœŸ</label>
                        <input type="date" id="together_date">
                    </div>
                    <div class="form-group">
                        <label>ç½‘ç«™æ ‡é¢˜</label>
                        <input type="text" id="site_title" placeholder="æˆ‘ä»¬çš„æ•…äº‹">
                    </div>
                </div>
                <div class="form-group">
                    <label>ç®€ä»‹</label>
                    <textarea id="bio" placeholder="è®°å½•æˆ‘ä»¬çš„ç¾å¥½æ—¶å…‰..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveProfile()">ğŸ’¾ ä¿å­˜ä¿¡æ¯</button>
            </div>

            <!-- ç…§ç‰‡ç®¡ç† -->
            <div id="photos-panel" class="panel">
                <button class="add-btn" onclick="openPhotoModal()">+ æ·»åŠ æ–°ç…§ç‰‡</button>
                <div id="photos-list"></div>
            </div>

            <!-- æ—¶é—´è½´ -->
            <div id="timeline-panel" class="panel">
                <button class="add-btn" onclick="openTimelineModal()">+ æ·»åŠ æ–°äº‹ä»¶</button>
                <div id="timeline-list"></div>
            </div>
        </div>
    </div>

    <!-- ç…§ç‰‡å¼¹çª— -->
    <div class="modal" id="photo-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="photo-modal-title">æ·»åŠ ç…§ç‰‡</h3>
                <button class="modal-close" onclick="closeModal('photo-modal')">&times;</button>
            </div>
            <input type="hidden" id="photo-id">
            <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="photo-title"></div>
            <div class="form-group"><label>è‹±æ–‡æ ‡é¢˜</label><input type="text" id="photo-en-title"></div>

            <!-- æ–°å¢ï¼šå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div class="form-group">
                <label>ä¸Šä¼ å›¾ç‰‡</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="photo-file" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary"
                        onclick="document.getElementById('photo-file').click()" id="upload-btn">
                        ğŸ“ é€‰æ‹©å›¾ç‰‡
                    </button>
                    <span id="upload-status" style="color: #888; font-size: 14px;"></span>
                </div>
                <div id="photo-preview" style="margin-top: 10px; display: none;">
                    <img id="preview-img"
                        style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #333;">
                </div>
            </div>

            <div class="form-group"><label>å›¾ç‰‡URL *</label><input type="text" id="photo-url" placeholder="ä¸Šä¼ åè‡ªåŠ¨å¡«å……ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥">
            </div>
            <div class="form-group"><label>æ—¥æœŸ *</label><input type="date" id="photo-date"></div>
            <div class="form-group"><label>æè¿°</label><textarea id="photo-desc"></textarea></div>
            <div class="form-group"><label>æ ‡ç­¾ (é€—å·åˆ†éš”)</label><input type="text" id="photo-tags"
                    placeholder="æ—…è¡Œ, ç¾é£Ÿ, çºªå¿µæ—¥"></div>
            <button class="btn btn-primary" onclick="savePhoto()">ä¿å­˜</button>
        </div>
    </div>

    <!-- æ—¶é—´è½´å¼¹çª— -->
    <div class="modal" id="timeline-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="timeline-modal-title">æ·»åŠ äº‹ä»¶</h3>
                <button class="modal-close" onclick="closeModal('timeline-modal')">&times;</button>
            </div>
            <input type="hidden" id="event-id">
            <div class="form-group"><label>æ ‡é¢˜ *</label><input type="text" id="event-title"></div>
            <div class="form-group"><label>æ—¥æœŸ *</label><input type="date" id="event-date"></div>
            <div class="form-group"><label>æè¿°</label><textarea id="event-desc"></textarea></div>
            <div class="form-group">
                <label>å›¾æ ‡</label>
                <select id="event-icon">
                    <option value="heart">â¤ï¸ çˆ±å¿ƒ</option>
                    <option value="star">â­ æ˜Ÿæ˜Ÿ</option>
                    <option value="gift">ğŸ ç¤¼ç‰©</option>
                    <option value="cake">ğŸ‚ è›‹ç³•</option>
                    <option value="ring">ğŸ’ æˆ’æŒ‡</option>
                    <option value="plane">âœˆï¸ é£æœº</option>
                    <option value="camera">ğŸ“· ç›¸æœº</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveTimeline()">ä¿å­˜</button>
        </div>
    </div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('admin_token') || '';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (token) { showMainPanel(); loadAllData(); }

        async function login() {
            const pwd = document.getElementById('password').value;
            try {
                const res = await fetch(`${API}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pwd }) });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('admin_token', token);
                    showMainPanel();
                    loadAllData();
                    toast('ç™»å½•æˆåŠŸï¼');
                } else {
                    toast('å¯†ç é”™è¯¯', true);
                }
            } catch (e) { toast('ç™»å½•å¤±è´¥', true); }
        }

        function logout() { token = ''; localStorage.removeItem('admin_token'); location.reload(); }
        function showMainPanel() { document.getElementById('login-panel').style.display = 'none'; document.getElementById('main-panel').style.display = 'block'; }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${name}-panel`).classList.add('active');
        }

        function headers() { return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }; }

        async function loadAllData() { await Promise.all([loadProfile(), loadPhotos(), loadTimeline()]); }

        async function loadProfile() {
            const res = await fetch(`${API}/profile`);
            const data = await res.json();
            document.getElementById('name1').value = data.name1 || '';
            document.getElementById('name2').value = data.name2 || '';
            document.getElementById('avatar1').value = data.avatar1 || '';
            document.getElementById('avatar2').value = data.avatar2 || '';
            document.getElementById('together_date').value = data.together_date || '';
            document.getElementById('site_title').value = data.site_title || '';
            document.getElementById('bio').value = data.bio || '';
        }

        async function saveProfile() {
            const body = {
                name1: document.getElementById('name1').value,
                name2: document.getElementById('name2').value,
                avatar1: document.getElementById('avatar1').value,
                avatar2: document.getElementById('avatar2').value,
                together_date: document.getElementById('together_date').value,
                site_title: document.getElementById('site_title').value,
                bio: document.getElementById('bio').value
            };
            await fetch(`${API}/admin/profile`, { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
            toast('ä¿å­˜æˆåŠŸï¼');
        }

        async function loadPhotos() {
            const res = await fetch(`${API}/photos`);
            const photos = await res.json();
            const list = document.getElementById('photos-list');
            list.innerHTML = photos.map(p => `
                <div class="list-item">
                    <div class="list-item-info">
                        <h4>${p.title}</h4>
                        <p>${p.date} â€¢ ${(p.tags || []).join(', ')}</p>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-secondary" onclick='editPhoto(${JSON.stringify(p)})'>ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deletePhoto(${p.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function openPhotoModal(photo = null) {
            document.getElementById('photo-modal-title').textContent = photo ? 'ç¼–è¾‘ç…§ç‰‡' : 'æ·»åŠ ç…§ç‰‡';
            document.getElementById('photo-id').value = photo?.id || '';
            document.getElementById('photo-title').value = photo?.title || '';
            document.getElementById('photo-en-title').value = photo?.en_title || '';
            document.getElementById('photo-url').value = photo?.image_url || '';
            document.getElementById('photo-date').value = photo?.date || '';
            document.getElementById('photo-desc').value = photo?.description || '';
            document.getElementById('photo-tags').value = (photo?.tags || []).join(', ');
            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            document.getElementById('photo-file').value = '';
            document.getElementById('upload-status').textContent = '';
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('photo-modal').classList.add('active');
        }
        function editPhoto(p) { openPhotoModal(p); }

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        document.getElementById('photo-file').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('photo-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);

            // ä¸Šä¼ åˆ° OSS
            const statusEl = document.getElementById('upload-status');
            const uploadBtn = document.getElementById('upload-btn');
            statusEl.textContent = 'â³ ä¸Šä¼ ä¸­...';
            statusEl.style.color = '#fbbf24';
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder', 'photos');

                const res = await fetch(`${API}/admin/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const result = await res.json();

                if (result.success) {
                    document.getElementById('photo-url').value = result.url;
                    statusEl.textContent = 'âœ… ä¸Šä¼ æˆåŠŸ';
                    statusEl.style.color = '#22c55e';
                    toast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    statusEl.textContent = 'âŒ ' + (result.error || 'ä¸Šä¼ å¤±è´¥');
                    statusEl.style.color = '#dc3545';
                    toast(result.error || 'ä¸Šä¼ å¤±è´¥', true);
                }
            } catch (err) {
                statusEl.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                statusEl.style.color = '#dc3545';
                toast('ä¸Šä¼ å¤±è´¥: ' + err.message, true);
            } finally {
                uploadBtn.disabled = false;
            }
        });

        async function savePhoto() {
            const id = document.getElementById('photo-id').value;
            const body = {
                title: document.getElementById('photo-title').value,
                en_title: document.getElementById('photo-en-title').value,
                image_url: document.getElementById('photo-url').value,
                date: document.getElementById('photo-date').value,
                description: document.getElementById('photo-desc').value,
                tags: document.getElementById('photo-tags').value.split(',').map(t => t.trim()).filter(Boolean)
            };
            if (id) {
                await fetch(`${API}/admin/photos/${id}`, { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
            } else {
                await fetch(`${API}/photos`, { method: 'POST', headers: headers(), body: JSON.stringify(body) });
            }
            closeModal('photo-modal');
            loadPhotos();
            toast('ä¿å­˜æˆåŠŸï¼');
        }

        async function deletePhoto(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) return;
            await fetch(`${API}/admin/photos/${id}`, { method: 'DELETE', headers: headers() });
            loadPhotos();
            toast('å·²åˆ é™¤');
        }

        async function loadTimeline() {
            const res = await fetch(`${API}/timeline`);
            const events = await res.json();
            const icons = { heart: 'â¤ï¸', star: 'â­', gift: 'ğŸ', cake: 'ğŸ‚', ring: 'ğŸ’', plane: 'âœˆï¸', camera: 'ğŸ“·' };
            const list = document.getElementById('timeline-list');
            list.innerHTML = events.map(e => `
                <div class="list-item">
                    <div class="list-item-info">
                        <h4>${icons[e.icon] || 'â¤ï¸'} ${e.title}</h4>
                        <p>${e.date}</p>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-secondary" onclick='editTimeline(${JSON.stringify(e)})'>ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteTimeline(${e.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function openTimelineModal(event = null) {
            document.getElementById('timeline-modal-title').textContent = event ? 'ç¼–è¾‘äº‹ä»¶' : 'æ·»åŠ äº‹ä»¶';
            document.getElementById('event-id').value = event?.id || '';
            document.getElementById('event-title').value = event?.title || '';
            document.getElementById('event-date').value = event?.date || '';
            document.getElementById('event-desc').value = event?.description || '';
            document.getElementById('event-icon').value = event?.icon || 'heart';
            document.getElementById('timeline-modal').classList.add('active');
        }
        function editTimeline(e) { openTimelineModal(e); }

        async function saveTimeline() {
            const id = document.getElementById('event-id').value;
            const body = {
                title: document.getElementById('event-title').value,
                date: document.getElementById('event-date').value,
                description: document.getElementById('event-desc').value,
                icon: document.getElementById('event-icon').value
            };
            if (id) {
                await fetch(`${API}/admin/timeline/${id}`, { method: 'PUT', headers: headers(), body: JSON.stringify(body) });
            } else {
                await fetch(`${API}/admin/timeline`, { method: 'POST', headers: headers(), body: JSON.stringify(body) });
            }
            closeModal('timeline-modal');
            loadTimeline();
            toast('ä¿å­˜æˆåŠŸï¼');
        }

        async function deleteTimeline(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿ')) return;
            await fetch(`${API}/admin/timeline/${id}`, { method: 'DELETE', headers: headers() });
            loadTimeline();
            toast('å·²åˆ é™¤');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function toast(msg, isError = false) {
            const t = document.createElement('div');
            t.className = 'toast' + (isError ? ' error' : '');
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>

</html>